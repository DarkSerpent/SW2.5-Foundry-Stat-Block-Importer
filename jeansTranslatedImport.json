{
  "name": "Jean's [ytimport] Translated",
  "type": "script",
  "flags": {
    "advanced-macros": {
      "runForSpecificUser": ""
    },
    "exportSource": {
      "world": "daemons-line",
      "system": "sw25",
      "coreVersion": "12.331",
      "systemVersion": "0.10.2"
    }
  },
  "command": "// ゆとシートIIインポートマクロ\nasync function yt2import() {\n  // ダイアログ\n  let abilist = false;\n  let abidesc = false;\n  let monabi = false;\n  let allattack = false;\n  let usefix = false;\n  let fileInput = await new Promise((resolve) => {\n    let dialogContent = `\n      <p>Select JSON file (YutoSheet II output)</p>\n      <p><input type=\"file\" id=\"json-file-input\" accept=\".json\" style=\"width: 100%;\" /></p>\n      <p></p>\n      <p><b>Monster Import Options</b></p>\n      <p><input id=\"abilist\" type=\"checkbox\" data-dtype=\"Boolean\" checked/><label for=\"abilist\">Create an item list of monster abilities</label></p>\n      <p><input id=\"abidesc\" type=\"checkbox\" data-dtype=\"Boolean\"/><label for=\"abilist\">Expand the list of monster abilities to the description tab</label></p>\n      <p><input id=\"monabi\" type=\"checkbox\" data-dtype=\"Boolean\"/><label for=\"monabi\">Create individual items with monster abilities</label></p>\n      <p><input id=\"allattack\" type=\"checkbox\" data-dtype=\"Boolean\"/><label for=\"allattack\">Multi-part monster: Create attacks for all parts</label></p>\n      <p><input id=\"usefix\" type=\"checkbox\" data-dtype=\"Boolean\" checked/><label for=\"usefix\">Use fixed values for monster abilities</label></p>\n    `;\n\n    new Dialog({\n      title: \"Yuto Sheet II Import\",\n      content: dialogContent,\n      buttons: {\n        ok: {\n          icon: '<i class=\"fas fa-check\"></i>',\n          label: \"Import\",\n          callback: (html) => {\n            let file = html.find(\"#json-file-input\")[0].files[0];\n            abilist = html.find(\"#abilist\")[0].checked;\n            abidesc = html.find(\"#abidesc\")[0].checked;\n            monabi = html.find(\"#monabi\")[0].checked;\n            allattack = html.find(\"#allattack\")[0].checked;\n            usefix = html.find(\"#usefix\")[0].checked;\n            if (!file) {\n              ui.notifications.warn(\"No file has been selected.\");\n              return;\n            }\n            resolve(file);\n          },\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: \"Cancel\",\n          callback: () => resolve(null),\n        },\n      },\n      default: \"ok\",\n      close: () => resolve(null),\n    }).render(true);\n  });\n\n  // JSON読み込み\n  let reader = new FileReader();\n  reader.onload = async (event) => {\n    try {\n      let data = JSON.parse(event.target.result);\n      let actorData;\n      let itemData = [];\n\n      // アクターデータ作成\n      // PC\n      let biography = decodeHTML(data.freeNote);\n\n      let hitweapon = \"\";\n      if (data.weapon1Name) hitweapon = data.weapon1Name;\n\n      if (!data.monsterName) {\n        itemData = [\n          {\n            name: \"生命抵抗力\",\n            type: \"check\",\n            system: {\n              description: \"\",\n              checkskill: \"adv\",\n              checkabi: \"vit\",\n              showbtcheck: true,\n            },\n          },\n          {\n            name: \"精神抵抗力\",\n            type: \"check\",\n            system: {\n              description: \"\",\n              checkskill: \"adv\",\n              checkabi: \"mnd\",\n              showbtcheck: true,\n            },\n          },\n        ];\n        let resourceList = [];\n        let dodgeList = [\n          \"ファイター\",\n          \"グラップラー\",\n          \"フェンサー\",\n          \"バトルダンサー\",\n        ];\n        let dodgeskill = [0, \"-\"];\n        let shooterLv = 0;\n        let wizardList = [\"ソーサラー\", \"コンジャラー\"];\n        let wzskill = [0, \"-\"];\n        let initiative = [0, \"-\", \"-\"];\n        let initList = [\"スカウト\", \"ウォーリーダー\"];\n        let mknowledge = [0, \"-\", \"-\"];\n        let mknowList = [\"セージ\", \"ライダー\"];\n        let weakriding = [0, \"-\", \"-\"];\n        let weakrList = [\"ライダー\"];\n        let weakhiding = [0, \"-\", \"-\"];\n        let weakhList = [\n          \"ウィークリング（ガルーダ）\",\n          \"ウィークリング（タンノズ）\",\n          \"ウィークリング（バジリスク）\",\n          \"ウィークリング（ミノタウロス）\",\n          \"ウィークリング（マーマン）\",\n          \"ディアボロ\",\n          \"ドレイク（ナイト）\",\n          \"ドレイク（ブロークン）\",\n          \"バジリスク\",\n          \"ダークトロール\",\n          \"アルボル\",\n          \"バーバヤガー\",\n          \"ケンタウロス\",\n          \"シザースコーピオン\",\n          \"ドーン\",\n          \"コボルド\",\n          \"ラミア\",\n          \"ラルヴァ\",\n        ];\n\n        // 技能追加\n        let baseString = data.sheetDescriptionS.split(\"技能:\")[1].trim();\n        let baseSkills = baseString.split(\"／\");\n        let skill = baseSkills.map((skill) => {\n          let match = skill.match(/([^\\d]+)(\\d+)/);\n          return { name: match[1], level: parseInt(match[2], 10), type: \"-\" };\n        });\n        for (let i = 1; ; i++) {\n          if (!data[`commonClass${i}`]) break;\n          skill.push({\n            name: data[`commonClass${i}`],\n            level: data[`lvCommon${i}`],\n            type: \"commonskill\",\n          });\n        }\n        for (let i = 0; i < skill.length; i++) {\n          let matchItem = game.items.find(\n            (item) => item.name === skill[i].name\n          );\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\"Item\", skill[i].name);\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            setData.system.skilllevel = skill[i].level;\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: skill[i].name,\n              type: \"skill\",\n              system: {\n                description: \"\",\n                skilllevel: skill[i].level,\n                skilltype: skill[i].type,\n              },\n            });\n          }\n\n          // 判定技能\n          if (dodgeList.includes(skill[i].name)) {\n            if (dodgeskill[0] < parseInt(skill[i].level)) {\n              dodgeskill[0] = parseInt(skill[i].level);\n              dodgeskill[1] = skill[i].name;\n            }\n          }\n          if (skill[i].name == \"シューター\") {\n            shooterLv = parseInt(skill[i].level);\n          }\n          if (wizardList.includes(skill[i].name)) {\n            if (wzskill[0] < parseInt(skill[i].level)) {\n              wzskill[0] = parseInt(skill[i].level);\n              wzskill[1] = skill[i].name;\n            }\n          }\n          if (initList.includes(skill[i].name)) {\n            if (initiative[0] < parseInt(skill[i].level)) {\n              initiative[0] = parseInt(skill[i].level);\n              initiative[1] = skill[i].name;\n              initiative[2] = \"agi\";\n            }\n          }\n          if (mknowList.includes(skill[i].name)) {\n            if (mknowledge[0] < parseInt(skill[i].level)) {\n              mknowledge[0] = parseInt(skill[i].level);\n              mknowledge[1] = skill[i].name;\n              mknowledge[2] = \"int\";\n            }\n          }\n          if (weakrList.includes(skill[i].name)) {\n            if (weakriding[0] < parseInt(skill[i].level)) {\n              weakriding[0] = parseInt(skill[i].level);\n              weakriding[1] = skill[i].name;\n              weakriding[2] = \"int\";\n            }\n          }\n\n          // リソース用判定\n          if (skill[i].name === \"バード\") {\n            resourceList.push(\"楽素：↑\");\n            resourceList.push(\"楽素：↓\");\n            resourceList.push(\"楽素：♡\");\n          } else if (skill[i].name === \"ジオマンサー\") {\n            resourceList.push(\"天の命脈点\");\n            resourceList.push(\"地の命脈点\");\n            resourceList.push(\"人の命脈点\");\n          } else if (skill[i].name === \"ウォーリーダー\") {\n            resourceList.push(\"陣気\");\n          }\n        }\n        if (weakhList.includes(data.race)) {\n          weakhiding[1] = \"adv\";\n          weakhiding[2] = \"int\";\n        }\n\n        itemData.push({\n          name: \"先制\",\n          type: \"check\",\n          system: {\n            description: \"\",\n            checkskill: initiative[1],\n            checkabi: initiative[2],\n            showbtcheck: true,\n          },\n        });\n        itemData.push({\n          name: \"魔物知識\",\n          type: \"check\",\n          system: {\n            description: \"\",\n            checkskill: mknowledge[1],\n            checkabi: mknowledge[2],\n            showbtcheck: true,\n          },\n        });\n        if (weakriding[2] != \"-\") {\n          itemData.push({\n            name: \"弱点隠蔽（騎獣）\",\n            type: \"check\",\n            system: {\n              description: \"\",\n              checkskill: weakriding[1],\n              checkabi: weakriding[2],\n              showbtcheck: true,\n            },\n          });\n        }\n        if (weakhiding[2] != \"-\") {\n          itemData.push({\n            name: \"弱点隠蔽\",\n            type: \"check\",\n            system: {\n              description: \"\",\n              checkskill: weakhiding[1],\n              checkabi: weakhiding[2],\n              showbtcheck: true,\n            },\n          });\n        }\n        // 言語追加\n        let defaultLang = [\n          {\n            race: \"人間\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"地方語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"エルフ\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"エルフ語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"ドワーフ\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"ドワーフ語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"タビット\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"神紀文明語\", talk: false, read: true },\n            ],\n          },\n          {\n            race: \"ルーンフォーク\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"魔動機文明語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"リカント\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"リカント語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"リルドラケン\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"ドラゴン語\", talk: true, read: false },\n            ],\n          },\n          {\n            race: \"グラスランナー\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"グラスランナー語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"メリア\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"妖精語\", talk: true, read: false },\n            ],\n          },\n          {\n            race: \"ティエンス\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"魔神語\", talk: true, read: false },\n            ],\n          },\n          {\n            race: \"レプラカーン\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"魔動機文明語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"アルヴ\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"地方語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"シャドウ\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"シャドウ語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"ソレイユ\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"ソレイユ語\", talk: true, read: false },\n            ],\n          },\n          {\n            race: \"ウィークリング\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"魔動機文明語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"スプリガン\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"魔法文明語\", talk: true, read: true },\n              { name: \"巨人語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"アビスボーン\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"地方語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"ハイマン\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"魔法文明語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"フロウライト\",\n            lang: [{ name: \"交易共通語\", talk: true, read: true }],\n          },\n          {\n            race: \"ディアボロ\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"魔神語\", talk: true, read: false },\n            ],\n          },\n          {\n            race: \"ドレイク\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"ドレイク語\", talk: true, read: true },\n              { name: \"汎用蛮族語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"バジリスク\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"バジリスク語\", talk: true, read: true },\n              { name: \"ドレイク語\", talk: true, read: true },\n              { name: \"汎用蛮族語\", talk: true, read: true },\n              { name: \"妖魔語\", talk: true, read: false },\n            ],\n          },\n          {\n            race: \"ダークトロール\",\n            lang: [\n              { name: \"汎用蛮族語\", talk: true, read: true },\n              { name: \"巨人語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"アルボル\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"汎用蛮族語\", talk: true, read: true },\n              { name: \"ドレイク語\", talk: true, read: true },\n              { name: \"妖精語\", talk: true, read: false },\n            ],\n          },\n          {\n            race: \"バーバヤガー\",\n            lang: [\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"魔法文明語\", talk: true, read: true },\n              { name: \"汎用蛮族語\", talk: true, read: true },\n              { name: \"ドレイク語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"ケンタウロス\",\n            lang: [\n              { name: \"汎用蛮族語\", talk: true, read: true },\n              { name: \"ケンタウロス語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"シザースコーピオン\",\n            lang: [\n              { name: \"汎用蛮族語\", talk: true, read: true },\n              { name: \"アンドロスコーピオン語\", talk: true, read: true },\n              { name: \"魔動機文明語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"ドーン\",\n            lang: [\n              { name: \"汎用蛮族語\", talk: true, read: true },\n              { name: \"交易共通語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"コボルド\",\n            lang: [\n              { name: \"汎用蛮族語\", talk: true, read: true },\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"妖魔語\", talk: true, read: false },\n            ],\n          },\n          {\n            race: \"ドレイクブロークン\",\n            lang: [\n              { name: \"汎用蛮族語\", talk: true, read: true },\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"ドレイク語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"ラミア\",\n            lang: [\n              { name: \"汎用蛮族語\", talk: true, read: true },\n              { name: \"交易共通語\", talk: true, read: true },\n              { name: \"ドレイク語\", talk: true, read: true },\n            ],\n          },\n          {\n            race: \"ラルヴァ\",\n            lang: [\n              { name: \"地方語\", talk: true, read: true },\n              { name: \"交易共通語\", talk: true, read: true },\n            ],\n          },\n        ];\n        for (let i = 0; i < defaultLang.length; i++) {\n          if (\n            data.race == defaultLang[i].race ||\n            data.race == \"ナイトメア（\" + defaultLang[i].race + \"）\"\n          ) {\n            for (let j = 0; j < defaultLang[i].lang.length; j++) {\n              let matchItem = game.items.find(\n                (item) => item.name === defaultLang[i].lang[j].name\n              );\n              if (!matchItem) {\n                matchItem = await findEntryInCompendium(\n                  \"Item\",\n                  defaultLang[i].lang[j].name\n                );\n              }\n              if (matchItem) {\n                let setData = duplicate(matchItem);\n                setData.system.conversation = defaultLang[i].lang[j].talk;\n                setData.system.reading = defaultLang[i].lang[j].read;\n                itemData.push(setData);\n              } else {\n                itemData.push({\n                  name: defaultLang[i].lang[j].name,\n                  type: \"language\",\n                  system: {\n                    conversation: defaultLang[i].lang[j].talk,\n                    reading: defaultLang[i].lang[j].read,\n                  },\n                });\n              }\n            }\n          }\n        }\n        for (let i = 1; ; i++) {\n          if (!data[`language${i}`]) break;\n          let talk = true;\n          let read = true;\n          if (!data[`language${i}Talk`]) talk = false;\n          if (!data[`language${i}Read`]) read = false;\n          let matchItem = game.items.find(\n            (item) => item.name === data[`language${i}`]\n          );\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\n              \"Item\",\n              data[`language${i}`]\n            );\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            setData.system.conversation = talk;\n            setData.system.reading = read;\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: data[`language${i}`],\n              type: \"language\",\n              system: {\n                conversation: talk,\n                reading: read,\n              },\n            });\n          }\n        }\n        // 武器追加\n        for (let i = 1; ; i++) {\n          if (!data[`weapon${i}Name`]) break;\n          let dedicated = true;\n          if (!data[`weapon${i}Own`]) dedicated = false;\n          let category;\n          switch (data[`weapon${i}Category`]) {\n            case \"ソード\":\n              category = \"sword\";\n              break;\n            case \"アックス\":\n              category = \"axe\";\n              break;\n            case \"スピア\":\n              category = \"spear\";\n              break;\n            case \"メイス\":\n              category = \"mace\";\n              break;\n            case \"スタッフ\":\n              category = \"staff\";\n              break;\n            case \"フレイル\":\n              category = \"flail\";\n              break;\n            case \"ウォーハンマー\":\n              category = \"warhammer\";\n              break;\n            case \"格闘\":\n              category = \"grapple\";\n              break;\n            case \"投擲\":\n              category = \"throw\";\n              break;\n            case \"ボウ\":\n              category = \"bow\";\n              break;\n            case \"クロスボウ\":\n              category = \"crossbow\";\n              break;\n            case \"ガン\":\n              category = \"gun\";\n              break;\n            default:\n              break;\n          }\n          let usage;\n          switch (data[`weapon${i}Usage`]) {\n            case \"1H\":\n              usage = \"1H\";\n              break;\n            case \"1H#\":\n              usage = \"1H#\";\n              break;\n            case \"1H投\":\n              usage = \"1HT\";\n              break;\n            case \"1H拳\":\n              usage = \"1HN\";\n              break;\n            case \"1H両\":\n              usage = \"1HB\";\n              break;\n            case \"2H\":\n              usage = \"2H\";\n              break;\n            case \"2H#\":\n              usage = \"2H#\";\n              break;\n            case \"振2H\":\n              usage = \"S2H\";\n              break;\n            case \"突2H\":\n              usage = \"P2H\";\n              break;\n            default:\n              break;\n          }\n          let matchItem = game.items.find(\n            (item) => item.name === data[`weapon${i}Name`]\n          );\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\n              \"Item\",\n              data[`weapon${i}Name`]\n            );\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            setData.system.equip = true;\n            setData.system.dedicated = dedicated;\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: data[`weapon${i}Name`],\n              type: \"weapon\",\n              system: {\n                description: data[`weapon${i}Note`],\n                equip: true,\n                dedicated: dedicated,\n                usedice: true,\n                usepower: true,\n                category: category,\n                usage: usage,\n                reqstr: Number(data[`weapon${i}Reqd`]),\n                hit: Number(data[`weapon${i}Acc`]),\n                dmod: Number(data[`weapon${i}Dmg`]),\n                power: Number(data[`weapon${i}Rate`]),\n                cvalue: Number(data[`weapon${i}Crit`]),\n              },\n            });\n          }\n        }\n        // 防具・盾追加\n        for (let i = 1; ; i++) {\n          if (!data[`armour${i}Name`]) break;\n          let dedicated = true;\n          if (!data[`armour${i}Own`]) dedicated = false;\n          let category;\n          switch (data[`armour${i}Category`]) {\n            case \"非金属鎧\":\n              category = \"nonmetalarmor\";\n              break;\n            case \"金属鎧\":\n              category = \"metalarmor\";\n              break;\n            case \"盾\":\n              category = \"shield\";\n              break;\n            case \"その他\":\n              category = \"other\";\n              break;\n            default:\n              break;\n          }\n          let matchItem = game.items.find(\n            (item) => item.name === data[`armour${i}Name`]\n          );\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\n              \"Item\",\n              data[`armour${i}Name`]\n            );\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            setData.system.equip = true;\n            setData.system.dedicated = dedicated;\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: data[`armour${i}Name`],\n              type: \"armor\",\n              system: {\n                description: data[`armour${i}Note`],\n                equip: true,\n                dedicated: dedicated,\n                category: category,\n                reqstr: Number(data[`armour${i}Reqd`]),\n                dodge: Number(data[`armour${i}Eva`]),\n                pp: Number(data[`armour${i}Def`]),\n              },\n            });\n          }\n        }\n        // 装飾品追加\n        let accessorypart = [\n          \"Head\",\n          \"Face\",\n          \"Ear\",\n          \"Neck\",\n          \"Back\",\n          \"HandR\",\n          \"HandL\",\n          \"Waist\",\n          \"Leg\",\n          \"Other\",\n        ];\n        for (let i = 0; i < accessorypart.length; i++) {\n          let addAcc = 0;\n          for (let j = 0; j <= addAcc; j++) {\n            let underbar = \"\";\n            for (let k = 0; k < j; k++) {\n              underbar += \"_\";\n            }\n            let accname = \"accessory\" + accessorypart[i] + underbar + \"Name\";\n            let accown = \"accessory\" + accessorypart[i] + underbar + \"Own\";\n            let accnote = \"accessory\" + accessorypart[i] + underbar + \"Note\";\n            let accadd = \"accessory\" + accessorypart[i] + underbar + \"Add\";\n\n            let accpart;\n            switch (accessorypart[i]) {\n              case \"Head\":\n                accpart = \"head\";\n                break;\n              case \"Face\":\n                accpart = \"face\";\n                break;\n              case \"Ear\":\n                accpart = \"ear\";\n                break;\n              case \"Neck\":\n                accpart = \"neck\";\n                break;\n              case \"Back\":\n                accpart = \"back\";\n                break;\n              case \"HandR\":\n                accpart = \"rhand\";\n                break;\n              case \"HandL\":\n                accpart = \"lhand\";\n                break;\n              case \"Waist\":\n                accpart = \"waist\";\n                break;\n              case \"Leg\":\n                accpart = \"leg\";\n                break;\n              case \"Other\":\n                accpart = \"other\";\n                break;\n              default:\n                break;\n            }\n\n            if (data[accadd]) addAcc += 1;\n\n            if (data[accname]) {\n              let dedicated = true;\n              if (!data[accown]) dedicated = false;\n              let matchItem = game.items.find(\n                (item) => item.name === data[accname]\n              );\n              if (!matchItem) {\n                matchItem = await findEntryInCompendium(\"Item\", data[accname]);\n              }\n              if (matchItem) {\n                let setData = duplicate(matchItem);\n                setData.system.equip = true;\n                setData.system.dedicated = dedicated;\n              } else {\n                setData = {\n                  name: data[accname],\n                  type: \"accessory\",\n                  system: {\n                    description: data[accnote],\n                    equip: true,\n                    dedicated: dedicated,\n                    accpart: accpart,\n                  },\n                };\n              }\n              if (data[accown] == \"HP\") {\n                setData.effects = [\n                  {\n                    name: \"専用装飾品：最大HP+2\",\n                    icon: \"icons/svg/regen.svg\",\n                    disabled: false,\n                    changes: [\n                      {\n                        mode: 2,\n                        value: \"2\",\n                        key: \"system.hp.efhpmod\",\n                      },\n                    ],\n                    transfer: true,\n                  },\n                ];\n              } else if (data[accown] == \"MP\") {\n                setData.effects = [\n                  {\n                    name: \"専用装飾品：最大MP+2\",\n                    icon: \"icons/svg/regen.svg\",\n                    disabled: false,\n                    changes: [\n                      {\n                        mode: 2,\n                        value: \"2\",\n                        key: \"system.mp.efmpmod\",\n                      },\n                    ],\n                    transfer: true,\n                  },\n                ];\n              }\n              itemData.push(setData);\n            }\n          }\n        }\n        // 種族特徴追加\n        let raceab = data.raceAbility.match(/［([^］]+)］/g);\n        let raceability = raceab.map((match) => match.replace(/[［］]/g, \"\"));\n        for (let i = 0; i < raceability.length; i++) {\n          let matchItem = game.items.find(\n            (item) => item.name === raceability[i]\n          );\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\"Item\", raceability[i]);\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: raceability[i],\n              type: \"raceability\",\n              system: {\n                description: \"\",\n              },\n            });\n          }\n        }\n        // 戦闘特技追加\n        let combatability = [];\n        let metafinalsong = false;\n        for (let i in data) {\n          if (i.startsWith(\"combatFeats\")) {\n            combatfeats = data[i].split(\",\");\n            for (const val of combatfeats) {\n              combatability.push(val);\n            }\n          }\n        }\n        for (let i = 0; i < combatability.length; i++) {\n          let matchItem = game.items.find(\n            (item) => item.name === combatability[i]\n          );\n          if (combatability[i] == \"終律増強\") {\n            metafinalsong = true;\n          }\n          if (combatability[i] == \"射手の体術\") {\n            if (dodgeskill[0] < shooterLv) {\n              dodgeskill[0] = shooterLv;\n              dodgeskill[1] = \"シューター\";\n            }\n          }\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\"Item\", combatability[i]);\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: combatability[i],\n              type: \"combatability\",\n              system: {\n                description: \"\",\n              },\n            });\n          }\n        }\n\n        // 練技追加\n        for (let i = 1; ; i++) {\n          if (!data[`craftEnhance${i}`]) break;\n          let matchItem = game.items.find(\n            (item) => item.name === data[`craftEnhance${i}`]\n          );\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\n              \"Item\",\n              data[`craftEnhance${i}`]\n            );\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            if (setData.system.usepower) {\n              setData.system.powerskill = \"エンハンサー\";\n            }\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: data[`craftEnhance${i}`],\n              type: \"enhancearts\",\n              system: {\n                description: \"\",\n              },\n            });\n          }\n        }\n        // 呪歌・終律追加\n        for (let i = 1; ; i++) {\n          if (!data[`craftSong${i}`]) break;\n          let type = \"song\";\n          if (/終律：/.test(data[`craftSong${i}`])) type = \"final\";\n          let songname = data[`craftSong${i}`].replace(/終律：/g, \"\");\n          let matchItem = game.items.find((item) => item.name === songname);\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\"Item\", songname);\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            if (setData.system.usepower) {\n              setData.system.powerskill = \"バード\";\n              // 終律増強\n              if (metafinalsong && setData.system.type == \"final\") {\n                setData.system.power = parseInt(setData.system.power) + 10;\n              }\n            }\n            if (setData.system.usedice) {\n              setData.system.checkskill = \"バード\";\n            }\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: songname,\n              type: \"magicalsong\",\n              system: {\n                description: \"\",\n                type: type,\n              },\n            });\n          }\n        }\n        // 騎芸追加\n        for (let i = 1; ; i++) {\n          if (!data[`craftRiding${i}`]) break;\n          let matchItem = game.items.find(\n            (item) => item.name === data[`craftRiding${i}`]\n          );\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\n              \"Item\",\n              data[`craftRiding${i}`]\n            );\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            if (setData.system.usedice) {\n              setData.system.checkskill = \"ライダー\";\n            }\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: data[`craftRiding${i}`],\n              type: \"ridingtrick\",\n              system: {\n                description: \"\",\n              },\n            });\n          }\n        }\n        // 賦術追加\n        for (let i = 1; ; i++) {\n          if (!data[`craftAlchemy${i}`]) break;\n          let matchItem = game.items.find(\n            (item) => item.name === data[`craftAlchemy${i}`]\n          );\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\n              \"Item\",\n              data[`craftAlchemy${i}`]\n            );\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            if (setData.system.usedice) {\n              setData.system.checkskill = \"アルケミスト\";\n            }\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: data[`craftAlchemy${i}`],\n              type: \"alchemytech\",\n              system: {\n                description: \"\",\n              },\n            });\n          }\n        }\n        // 相域追加\n        for (let i = 1; ; i++) {\n          if (!data[`craftGeomancy${i}`]) break;\n          let index = data[`craftGeomancy${i}`].indexOf(\"相：\");\n          let paname = data[`craftGeomancy${i}`].substring(\n            index + \"相：\".length\n          );\n          let patype = data[`craftGeomancy${i}`].charAt(index - 1);\n          let type;\n          switch (patype) {\n            case \"天\":\n              type = \"ten\";\n              break;\n            case \"地\":\n              type = \"chi\";\n              break;\n            case \"人\":\n              type = \"jin\";\n              break;\n            default:\n              break;\n          }\n          let matchItem = game.items.find((item) => item.name === paname);\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\"Item\", paname);\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: paname,\n              type: \"phasearea\",\n              system: {\n                description: \"\",\n                type: type,\n              },\n            });\n          }\n        }\n        // 鼓砲・陣率追加\n        for (let i = 1; ; i++) {\n          if (!data[`craftCommand${i}`]) break;\n          let type = \"drum\";\n          if (/陣率：/.test(data[`craftCommand${i}`])) type = \"camp\";\n          let tacname = data[`craftCommand${i}`].replace(/陣率：/g, \"\");\n          let matchItem = game.items.find((item) => item.name === tacname);\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\"Item\", tacname);\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: tacname,\n              type: \"tactics\",\n              system: {\n                description: \"\",\n                type: type,\n                line: \"-\",\n              },\n            });\n          }\n        }\n\n        // マテリアルカード追加\n        let materialE = [\"Red\", \"Gre\", \"Bla\", \"Whi\", \"Gol\"];\n        let materialJ = [\"赤\", \"緑\", \"黒\", \"白\", \"金\"];\n        let materialR = [\"B\", \"A\", \"S\", \"SS\"];\n        for (let i = 0; i < materialE.length; i++) {\n          for (const crank of materialR) {\n            if (data[\"card\" + materialE[i] + crank]) {\n              let cardName = \"マテリアルカード（\" + materialJ[i] + crank + \"）\";\n              let quantity = parseInt(data[\"card\" + materialE[i] + crank]);\n\n              let matchItem = game.items.find((item) => item.name === cardName);\n              if (!matchItem) {\n                matchItem = await findEntryInCompendium(\"Item\", cardName);\n              }\n              if (matchItem) {\n                let setData = duplicate(matchItem);\n                setData.system.quantity = quantity;\n                itemData.push(setData);\n              } else {\n                itemData.push({\n                  name: data[`craftEnhance${i}`],\n                  type: \"item\",\n                  system: {\n                    quantity: quantity,\n                    description: \"\",\n                  },\n                });\n              }\n            }\n          }\n        }\n\n        // リソース追加\n        for (const resource of resourceList) {\n          let matchItem = game.items.find((item) => item.name === resource);\n          if (!matchItem) {\n            matchItem = await findEntryInCompendium(\"Item\", resource);\n          }\n          if (matchItem) {\n            let setData = duplicate(matchItem);\n            itemData.push(setData);\n          } else {\n            itemData.push({\n              name: resource,\n              type: \"resource\",\n              system: {\n                description: \"\",\n                quantity: 0,\n              },\n            });\n          }\n        }\n\n        actorData = {\n          name: data.characterName,\n          type: \"character\",\n          system: {\n            abilities: {\n              dex: {\n                racevalue: Number(data.sttBaseTec),\n                valuebase: Number(data.sttBaseA),\n                valuegrowth: Number(data.sttGrowA),\n                valuemodify: Number(data.sttAddA),\n              },\n              agi: {\n                valuebase: Number(data.sttBaseB),\n                valuegrowth: Number(data.sttGrowB),\n                valuemodify: Number(data.sttAddB),\n              },\n              str: {\n                racevalue: Number(data.sttBasePhy),\n                valuebase: Number(data.sttBaseC),\n                valuegrowth: Number(data.sttGrowC),\n                valuemodify: Number(data.sttAddC),\n              },\n              vit: {\n                valuebase: Number(data.sttBaseD),\n                valuegrowth: Number(data.sttGrowD),\n                valuemodify: Number(data.sttAddD),\n              },\n              int: {\n                racevalue: Number(data.sttBaseSpi),\n                valuebase: Number(data.sttBaseE),\n                valuegrowth: Number(data.sttGrowE),\n                valuemodify: Number(data.sttAddE),\n              },\n              mnd: {\n                valuebase: Number(data.sttBaseF),\n                valuegrowth: Number(data.sttGrowF),\n                valuemodify: Number(data.sttAddF),\n              },\n            },\n            money: data.moneyTotal,\n            race: data.race,\n            biography: biography,\n            attributes: {\n              age: data.age,\n              gender: data.gender,\n              born: data.birth,\n              faith: data.faith,\n              honer: {\n                rank: data.rank,\n                value: data.honor,\n              },\n              impurity: data.sin,\n              totalexp: data.expTotal,\n            },\n            hitweapon: hitweapon,\n            attackskill: data.weapon1Class,\n            dodgeskill: dodgeskill[1],\n            herbskill: \"レンジャー\",\n            potionskill: \"レンジャー\",\n            repairskill: \"ライダー\",\n            scskill: \"ソーサラー\",\n            cnskill: \"コンジャラー\",\n            wzskill: wzskill[1],\n            prskill: \"プリースト\",\n            mtskill: \"マギテック\",\n            frskill: \"フェアリーテイマー\",\n            drskill: \"ドルイド\",\n            dmskill: \"デーモンルーラー\",\n          },\n        };\n\n        createActor(actorData, itemData);\n      }\n\n      // 魔物・騎獣データ\n      if (data.monsterName != null) {\n        let name = data.monsterName;\n        if (data.characterName != null) name = data.characterName;\n        let part = data.partsNum + \" (\" + data.parts + \")\";\n        if (data.partsNum == 1 || data.partsNum == null) part = null;\n        let loot = \"\";\n        let lootNum = Number(data.lootsNum);\n        if (lootNum > 0) {\n          for (let i = 1; i <= lootNum; i++) {\n            let numName = `data.loots${i}Num`;\n            let itemName = `data.loots${i}Item`;\n            let num = eval(numName);\n            let item = eval(itemName);\n            loot += num + \" : \" + item + \"<br>\";\n          }\n        }\n        let biography;\n        let feature = data.skills.replace(/&lt;br&gt;/g, \"<br>\");\n\n        let actorNum = parseInt(data.statusNum, 10)\n          ? parseInt(data.statusNum, 10)\n          : 1;\n\n        let mountLv = parseInt(data.lvMin)\n          ? parseInt(data.lv) - parseInt(data.lvMin)\n          : 0;\n        let access = mountLv == 0 ? 1 : 1 + \"-\" + (mountLv + 1);\n\n        let vitResist = data.vitResist\n          ? data.vitResist\n          : data[\"status\" + access + \"Vit\"];\n        let mndResist = data.mndResist\n          ? data.mndResist\n          : data[\"status\" + access + \"Mnd\"];\n\n        itemData = [\n          {\n            name: \"Resist\",\n            type: \"monsterability\",\n            system: {\n              description: \"\",\n              usedice1: true,\n              label1: \"Fortitude\",\n              checkbasemod1: eval(vitResist),\n              usefix1: usefix,\n              applycheck1: false,\n              usedice2: true,\n              label2: \"Willpower\",\n              checkbasemod2: eval(mndResist),\n              usefix2: usefix,\n              applycheck2: false,\n            },\n          },\n        ];\n\n        let partsList = [];\n        for (var i = 1; i <= actorNum; i++) {\n          let mountLv = parseInt(data.lvMin)\n            ? parseInt(data.lv) - parseInt(data.lvMin)\n            : 0;\n          access = mountLv == 0 ? i : i + \"-\" + (mountLv + 1);\n          let itemDamage = data[\"status\" + access + \"Damage\"].replace(\n            /\\b2d6\\b|\\b2d\\b/g,\n            \"\"\n          );\n\n          if (!isNaN(itemDamage)) {\n            itemData.push({\n              name: data[\"status\" + i + \"Style\"],\n              type: \"monsterability\",\n              system: {\n                description: \"\",\n                usedice1: true,\n                label1: \"Accuracy\",\n                checkbasemod1: eval(data[\"status\" + access + \"Accuracy\"]),\n                usefix1: usefix,\n                applycheck1: false,\n                usedice2: true,\n                label2: \"Damage\",\n                checkbasemod2: itemDamage,\n                usefix2: false,\n                applycheck2: true,\n                usedice3: true,\n                label3: \"Evasion\",\n                checkbasemod3: eval(data[\"status\" + access + \"Evasion\"]),\n                usefix3: usefix,\n                applycheck3: false,\n              },\n            });\n          }\n          if (abidesc)\n            partsList.push([\n              data[\"status\" + i + \"Style\"],\n              eval(data[\"status\" + access + \"Accuracy\"]),\n              data[\"status\" + access + \"Damage\"],\n              eval(data[\"status\" + access + \"Evasion\"]),\n              eval(data[\"status\" + access + \"Defense\"]),\n              eval(data[\"status\" + access + \"Hp\"]),\n              eval(data[\"status\" + access + \"Mp\"]),\n            ]);\n        }\n\n        if (abidesc)\n          biography = getBiography(feature, data.description, partsList);\n        else biography = \"<h3><b>Description</b></h3>\" + decodeHTML(data.description);\n\n        if (monabi) {\n          abilityList = analysisFeature(feature, usefix);\n          for (const val of abilityList) {\n            itemData.push(val);\n          }\n        }\n        if (abilist) {\n          itemData.push({\n            name: \"Monster Ability\",\n            type: \"monsterability\",\n            system: {\n              description: feature,\n            },\n          });\n        }\n\n        for (var i = 1; i <= actorNum; i++) {\n          let partsName = data[\"status\" + i + \"Style\"];\n          partsName = partsName.replace(/.*[\\(（]/, \"\").replace(/[\\)）].*/, \"\");\n          let actName = actorNum == 1 ? name : name + \" (\" + partsName + \")\";\n\n          let mountLv = parseInt(data.lvMin)\n            ? parseInt(data.lv) - parseInt(data.lvMin)\n            : 0;\n          let access = mountLv == 0 ? i : i + \"-\" + (mountLv + 1);\n\n          actorData = {\n            name: actName,\n            type: \"monster\",\n            system: {\n              hp: {\n                value: eval(data[\"status\" + access + \"Hp\"]),\n              },\n              mp: {\n                value: eval(data[\"status\" + access + \"Mp\"]),\n              },\n              monlevel: data.lv,\n              hpbase: eval(data[\"status\" + access + \"Hp\"]),\n              mpbase: eval(data[\"status\" + access + \"Mp\"]),\n              ppbase: eval(data[\"status\" + access + \"Defense\"]),\n              type: data.taxa,\n              intelligence: data.intellect,\n              perception: data.perception,\n              reaction: data.disposition,\n              impurity: data.sin,\n              language: data.language,\n              habitat: data.habitat,\n              popularity: data.reputation,\n              weakpoint: data[\"reputation+\"],\n              weakness: data.weakness,\n              preemptive: data.initiative,\n              move: data.mobility,\n              part: part,\n              corepart: data.coreParts,\n              biography: biography,\n              loot: loot,\n            },\n          };\n\n          let applyItemData = [];\n          if (!allattack) {\n            applyItemData = itemData.filter(\n              (item) =>\n                !(\n                  item.name != data[\"status\" + i + \"Style\"] &&\n                  item.system.label1 == \"命中\" &&\n                  item.system.label2 == \"打撃\" &&\n                  item.system.label3 == \"回避\"\n                )\n            );\n          } else applyItemData = itemData;\n\n          createActor(actorData, applyItemData);\n        }\n      }\n    } catch (e) {\n      ui.notifications.error(\"ファイル形式エラー\");\n      console.error(e);\n    }\n  };\n  if (fileInput) {\n    reader.readAsText(fileInput);\n  }\n}\n\n// アクター作成\nfunction createActor(actorData, itemData) {\n  Actor.create(actorData)\n    .then((actor) => {\n      setTimeout(() => {\n        let existingItems = actor.items.map((item) => item.id);\n        actor\n          .deleteEmbeddedDocuments(\"Item\", existingItems)\n          .then(() => {\n            return actor.createEmbeddedDocuments(\"Item\", itemData);\n          })\n          .then(() => {\n            ui.notifications.info(`「${actor.name}」が作成されました。`);\n          })\n          .catch((error) => {\n            console.error(error);\n            ui.notifications.error(\n              \"アイテムの削除または追加中にエラーが発生しました。\"\n            );\n          });\n      }, 500);\n    })\n    .catch((error) => {\n      console.error(error);\n      ui.notifications.error(\"作成に失敗しました。\");\n    });\n}\n\n// 魔物特殊能力解析\nfunction analysisFeature(feature, usefix) {\n  const array = feature.split(\"<br>\");\n  var parts = \"\";\n  const patternParts = /^●(.*)$/g;\n  const patternMagic =\n    /^(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)+(.*)[/／]魔力([0-9０-９]+).*$/g;\n  const patternSkill =\n    /^(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)+(.*)[/／]([0-9０-９]+)[0-9０-９\\(\\)（）]+[/／](.*)$/g;\n  const patternSplit =\n    /^(●|\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑).*$/g;\n  const patternConst =\n    /^(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)*(\\[常\\]|○|◯|〇)(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)*.*$/g;\n  const patternMain =\n    /^(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)*(\\[主\\]|＞|▶|〆)(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)*.*$/g;\n  const patternAux =\n    /^(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)*(\\[補\\]|≫|>>|☆)(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)*.*$/g;\n  const patternPrep =\n    /^(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)*(\\[戦\\]|△)(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)*.*$/g;\n  const patternDecia =\n    /^(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)*(\\[宣\\]|🗨|□|☑)(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)*.*$/g;\n  const patternReplace =\n    /(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑)/g;\n\n  let ability = [];\n\n  var skill = [\n    \"\",\n    \"\",\n    \"\",\n    \"\",\n    \"\",\n    false,\n    usefix,\n    false,\n    false,\n    false,\n    false,\n    false,\n  ];\n  var output = false;\n\n  for (const val of array) {\n    var match = \"\";\n\n    // 能力区切り\n    match = val.match(patternSplit);\n    if (match != null && output) {\n      ability.push({\n        name: skill[0],\n        type: \"monsterability\",\n        system: {\n          usedice1: skill[5],\n          label1: skill[1],\n          checkbasemod1: skill[2],\n          usefix1: skill[6],\n          applycheck1: false,\n          remark: skill[3],\n          description: skill[4],\n          constant: skill[7],\n          main: skill[8],\n          aux: skill[9],\n          prep: skill[10],\n          decla: skill[11],\n        },\n      });\n\n      skill = [\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        false,\n        usefix,\n        false,\n        false,\n        false,\n        false,\n        false,\n      ];\n      output = false;\n    }\n\n    // 常時特技\n    match = val.match(patternConst);\n    if (match != null) {\n      skill[0] = match[0].replace(patternReplace, \"\");\n      skill[7] = true;\n      output = true;\n    }\n\n    // 主動作\n    match = val.match(patternMain);\n    if (match != null) {\n      skill[0] = match[0].replace(patternReplace, \"\");\n      skill[8] = true;\n      output = true;\n    }\n\n    // 補助動作\n    match = val.match(patternAux);\n    if (match != null) {\n      skill[0] = match[0].replace(patternReplace, \"\");\n      skill[9] = true;\n      output = true;\n    }\n\n    // 戦闘準備\n    match = val.match(patternPrep);\n    if (match != null) {\n      skill[0] = match[0].replace(patternReplace, \"\");\n      skill[10] = true;\n      output = true;\n    }\n\n    // 宣言特技\n    match = val.match(patternDecia);\n    if (match != null) {\n      skill[0] = match[0].replace(patternReplace, \"\");\n      skill[11] = true;\n      output = true;\n    }\n\n    // 部位判定\n    match = val.match(patternParts);\n    if (match != null) {\n      parts = \"[\" + match[0].replace(\"●\", \"\") + \"]\";\n\n      skill = [\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        false,\n        usefix,\n        false,\n        false,\n        false,\n        false,\n        false,\n      ];\n      continue;\n    }\n\n    // 魔法判定\n    match = val.match(patternMagic);\n    if (match != null) {\n      var split = match[0].split(patternMagic);\n      skill[0] = parts != \"\" ? parts + split[2] : split[2];\n      skill[1] = \"魔力\";\n      if (skill[0].includes(\"真語魔法\")) skill[1] = \"真語魔力\";\n      if (skill[0].includes(\"操霊魔法\")) skill[1] = \"操霊魔力\";\n      if (skill[0].includes(\"深智魔法\")) skill[1] = \"深智魔力\";\n      if (skill[0].includes(\"神聖魔法\")) skill[1] = \"神聖魔力\";\n      if (skill[0].includes(\"魔動機術\")) skill[1] = \"魔動機術魔力\";\n      if (skill[0].includes(\"妖精魔法\")) skill[1] = \"妖精魔力\";\n      if (skill[0].includes(\"森羅魔法\")) skill[1] = \"森羅魔力\";\n      if (skill[0].includes(\"召異魔法\")) skill[1] = \"召異魔力\";\n      skill[2] = parseInt(toHalfWidth(split[3]), 10);\n      skill[3] = \"\";\n      skill[4] = match[0];\n      skill[5] = true;\n      skill[6] = true;\n      output = true;\n\n      continue;\n    }\n\n    // 特殊能力判定\n    match = val.match(patternSkill);\n    if (match != null) {\n      var split = match[0].split(patternSkill);\n\n      skill[0] = parts != \"\" ? parts + split[2] : split[2];\n      skill[1] = \"判定\";\n      skill[2] = parseInt(toHalfWidth(split[3]), 10);\n      skill[3] = split[4];\n      skill[4] = match[0];\n      skill[5] = true;\n      skill[6] = true;\n      output = true;\n\n      continue;\n    }\n\n    skill[4] = skill[4] + \"<br>\" + val;\n  }\n\n  if (output) {\n    ability.push({\n      name: skill[0],\n      type: \"monsterability\",\n      system: {\n        usedice1: skill[5],\n        label1: skill[1],\n        checkbasemod1: skill[2],\n        usefix1: skill[6],\n        applycheck1: false,\n        remark: skill[3],\n        description: skill[4],\n        constant: skill[7],\n        main: skill[8],\n        aux: skill[9],\n        prep: skill[10],\n        decla: skill[11],\n      },\n    });\n\n    output = false;\n  }\n\n  return ability;\n}\n\n// 魔物特殊能力HTML成型\nfunction convertHtmlFromFeature(feature) {\n  var ret = '<section class=\"box\">';\n  const array = feature.split(\"<br>\");\n  var parts = \"\";\n  const patternParts = /^●(.*)$/g;\n  const patternSplit =\n    /^(\\[常\\]|○|◯|〇|\\[戦\\]|△|\\[主\\]|＞|▶|〆|\\[補\\]|≫|>>|☆|\\[宣\\]|🗨|□|☑).*$/g;\n  for (const val of array) {\n    var match = \"\";\n\n    // 部位判定\n    match = val.match(patternParts);\n    if (match != null) {\n      ret = ret + \"<h3>\" + val + \"</h3>\";\n      continue;\n    }\n\n    // 能力区切り\n    match = val.match(patternSplit);\n    if (match != null) {\n      ret = ret + \"<h4>\" + val + \"</h4>\";\n      continue;\n    }\n    if (val != \"\") {\n      ret = ret + val + \"<br>\";\n    }\n  }\n  ret = ret + \"</section>\";\n  return ret;\n}\n\nfunction getBiography(feature, description, partsList) {\n  let biography = `\n      <table class=\"status\">\n        <thead>\n          <tr>\n            <th>攻撃方法（部位）\n            <th>命中力\n            <th>打撃点\n            <th>回避力\n            <th>防護点\n            <th>ＨＰ\n            <th>ＭＰ\n        </thead>\n        <tbody>\n   `;\n  for (const parts of partsList) {\n    acc = parts[1] + 7;\n    eva = parts[3] + 7;\n    biography += `\n            <tr>\n              <td class=\"pt-item\">${parts[0]}\n              <td class=\"pt-item\">${parts[1]} (${acc})\n              <td class=\"pt-item\">${parts[2]}\n              <td class=\"pt-item\">${parts[3]} (${eva})\n              <td class=\"pt-item\">${parts[4]}\n              <td class=\"pt-item\">${parts[5]}\n              <td class=\"pt-item\">${parts[6]}\n     `;\n  }\n  biography += `\n        </tbody>\n      </table>\n   `;\n\n  biography +=\n    convertHtmlFromFeature(feature) +\n    \"<br><h3><b>Description</b></h3>\" +\n    decodeHTML(description);\n  return biography;\n}\n\n// 全角半角変換関数\nfunction toHalfWidth(str) {\n  // 全角英数字を半角に変換\n  str = str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function (s) {\n    return String.fromCharCode(s.charCodeAt(0) - 0xfee0);\n  });\n  return str;\n}\n\n// HTMLデコード関数\nfunction decodeHTML(escapedText) {\n  const parser = new DOMParser();\n  const doc = parser.parseFromString(escapedText, \"text/html\");\n  return doc.documentElement.textContent;\n}\n\n// Compendium検索関数\nasync function findEntryInCompendium(type, entryName) {\n  const packs = game.packs\n    .filter((p) => p.documentClass.documentName === type)\n    .sort((a, b) => a.metadata.label.localeCompare(b.metadata.label));\n  for (const pack of packs) {\n    const index = await pack.getIndex();\n    const entryIndex = index.find((e) => e.name === entryName);\n    if (entryIndex) {\n      const compEntry = await pack.getDocument(entryIndex._id);\n      return compEntry;\n    }\n  }\n  return null;\n}\n\n// マクロ実行\nyt2import();",
  "img": "icons/svg/clockwork.svg",
  "author": "PCQ5gKit0peQgqz8",
  "scope": "global",
  "folder": null,
  "_stats": {
    "coreVersion": "12.331",
    "systemId": "sw25",
    "systemVersion": "0.10.2",
    "createdTime": 1726614235711,
    "modifiedTime": 1726619783262,
    "lastModifiedBy": "PCQ5gKit0peQgqz8"
  }
}